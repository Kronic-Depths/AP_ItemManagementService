/*
 *  Copyright 2017 Regents of the University of California.
 *
 *  Licensed under the Educational Community License, Version 2.0 (the "license");
 *  you may not use this file except in compliance with the License. You may
 *  obtain a copy of the license at
 *
 *  https://opensource.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package org.opentestsystem.ap.ims.util;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.Spy;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.ap.ims.entity.ItemBankUser;
import org.opentestsystem.security.model.User;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;

import static org.apache.commons.lang3.StringUtils.EMPTY;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;
import static org.opentestsystem.ap.ims.util.SecurityUtil.USER_ANONYMOUS;

@RunWith(MockitoJUnitRunner.class)
public class SecurityUtilTest {

    private static final String USERNAME = "johndoe@fake.com";

    private static final String FULLNAME = "John Doe";

    @Mock
    private Authentication mockAuthentication;

    @Mock
    private UserDetails mockUserDetails;

    @Mock
    private User mockUser;

    @Spy
    private SecurityUtil spy;

    @Test
    public void itShouldGetItemBankUserNoArgs() {
        final ItemBankUser user = spy.getItemBankUser();
        assertThat(user.getUsername()).isEqualTo(USER_ANONYMOUS);
        assertThat(user.getFullname()).isEqualTo(USER_ANONYMOUS);
    }
    
    @Test
    public void itShouldGetItemBankUserWhenAuthenticationIsNull() {
        final ItemBankUser user = spy.getItemBankUser(null);
        assertThat(user.getUsername()).isEqualTo(USER_ANONYMOUS);
        assertThat(user.getFullname()).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldGetItemBankUserWhenPrincipalIsNull() {
        when(mockAuthentication.getPrincipal()).thenReturn(null);
        final ItemBankUser user = spy.getItemBankUser(mockAuthentication);
        assertThat(user.getUsername()).isEqualTo(USER_ANONYMOUS);
        assertThat(user.getFullname()).isEqualTo(USER_ANONYMOUS);
    }


    @Test
    public void itShouldGetItemBankUserWhenPrincipalIsString() {
        final String username = "Principal-As-String";
        when(mockAuthentication.getPrincipal()).thenReturn(username);
        final ItemBankUser user = spy.getItemBankUser(mockAuthentication);
        assertThat(user.getUsername()).isEqualTo(username);
        assertThat(user.getFullname()).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldGetItemBankUserWhenPrincipalIsUser() {
        final String username = "Principal-As-User.username";
        final String fullname = "Principal-As-User.fullname";

        when(mockUser.getUsername()).thenReturn(username);
        when(mockUser.getFullName()).thenReturn(fullname);
        when(mockAuthentication.getPrincipal()).thenReturn(mockUser);

        final ItemBankUser user = spy.getItemBankUser(mockAuthentication);

        assertThat(user.getUsername()).isEqualTo(username);
        assertThat(user.getFullname()).isEqualTo(fullname);
    }

    @Test
    public void itShouldGetItemBankUserWhenPrincipalIsUserDetails() {
        final String username = "Principal-As-UserDetails.username";

        when(mockUserDetails.getUsername()).thenReturn(username);
        when(mockAuthentication.getPrincipal()).thenReturn(mockUserDetails);

        final ItemBankUser user = spy.getItemBankUser(mockAuthentication);

        assertThat(user.getUsername()).isEqualTo(username);
        assertThat(user.getFullname()).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldParseUserName() {
        assertParsedUsername("itShouldCreateSAItemAndUpdateItWithChanges", "itShouldCreateSAItemAndUpdateItWithChanges");
        assertParsedUsername("itShouldCreateSAItemAndUpdateItWithChanges@fake.com", "itShouldCreateSAItemAndUpdateItWithChanges");
        assertParsedUsername("@fake.com", EMPTY);
        assertParsedUsername(null, null);
        assertParsedUsername(EMPTY, EMPTY);
    }

    private void assertParsedUsername(String username, String expected) {
        ItemBankUser user = new ItemBankUser(username, "Test User");
        assertThat(user.parseUsername()).isEqualTo(expected);
    }

    @Test
    public void itShouldGetAnonymousUsername() {
        when(spy.getAuthentication()).thenReturn(null);
        final String username = spy.getUsername();
        assertThat(username).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldGetUsernameAnonymousFromNullPrincipal() {
        when(mockAuthentication.getPrincipal()).thenReturn(null);
        when(spy.getAuthentication()).thenReturn(mockAuthentication);
        final String actual = spy.getUsername();
        assertThat(actual).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldGetUsernameFromString() {
        when(mockAuthentication.getPrincipal()).thenReturn(USERNAME);
        when(spy.getAuthentication()).thenReturn(mockAuthentication);
        final String actual = spy.getUsername();
        assertThat(actual).isEqualTo(USERNAME);
    }

    @Test
    public void itShouldGetUsernameFromUserDetails() {
        when(mockUserDetails.getUsername()).thenReturn(USERNAME);
        when(mockAuthentication.getPrincipal()).thenReturn(mockUserDetails);
        when(spy.getAuthentication()).thenReturn(mockAuthentication);
        final String actual = spy.getUsername();
        assertThat(actual).isEqualTo(USERNAME);
    }

    @Test
    public void itShouldGetFullnameAnonymous() {
        when(spy.getAuthentication()).thenReturn(null);
        final String actual = spy.getFullname();
        assertThat(actual).isEqualTo(USER_ANONYMOUS);
    }

    @Test
    public void itShouldGetFullnameFromUser() {
        when(mockUser.getFullName()).thenReturn(FULLNAME);
        when(mockAuthentication.getPrincipal()).thenReturn(mockUser);
        when(spy.getAuthentication()).thenReturn(mockAuthentication);
        final String actual = spy.getFullname();
        assertThat(actual).isEqualTo(FULLNAME);
    }

    @Test
    public void itShouldGetNullFullname() {
        when(mockAuthentication.getPrincipal()).thenReturn(mockUserDetails);
        when(spy.getAuthentication()).thenReturn(mockAuthentication);
        final String actual = spy.getFullname();
        assertThat(actual).isNull();
    }

}
