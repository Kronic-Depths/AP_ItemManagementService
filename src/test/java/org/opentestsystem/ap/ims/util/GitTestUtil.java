/*
 *  Copyright 2017 Regents of the University of California.
 *
 *  Licensed under the Educational Community License, Version 2.0 (the "license");
 *  you may not use this file except in compliance with the License. You may
 *  obtain a copy of the license at
 *
 *  https://opensource.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package org.opentestsystem.ap.ims.util;

import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.ims.config.GitlabProperties;
import org.opentestsystem.ap.ims.entity.ItemBankUser;

import java.io.File;
import java.io.IOException;
import java.nio.file.FileVisitOption;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Comparator;

/**
 * When instantiated the utility creates a temp directory and another directory in it.
 * These represent the local repo base and a local repository.
 */
@Slf4j
@Getter
public class GitTestUtil {

    public static final ItemBankUser ITEM_BANK_USER = new ItemBankUser("test@fake.com", "Test User");

    public static final Integer GROUP_ID = 8765309;

    public static final String ITEM_ID = "test-item";

    private GitlabProperties gitlabProperties;

    private Path localBaseDir;

    private Path localRepoDir;

    private String gitlabHost = "https://gitlab-dev.smarterbalanced.org";

    private String gitlabUser = "testUser";

    private String gitlabPass = "testPass";

    private String gitlabGroup = "TestItembank";

    private String gitLabProject = ITEM_ID;

    private int idMinValue = 1000000000;

    private int idMaxValue = Integer.MAX_VALUE;

    /**
     * Creates a temporary directory using a prefix of <code>gitlabGroup</code>.
     * A directory is created in the temp directory with the name <code>gitLabProject</code>.
     * The <code>GitlabProperties</code> instance is created with the default values set on the
     * class's instance properties.
     */
    public GitTestUtil() {
        init();
    }

    /**
     * Same as the default constructor but instead of using default values the class's instance properties
     * are first set with the arguments of the constructor.
     */
    public GitTestUtil(String gitlabHost, String gitlabUser, String gitlabPass, String gitlabGroup,
                       String gitLabProject, int idMinValue, int idMaxValue) {
        this.gitlabHost = gitlabHost;
        this.gitlabUser = gitlabUser;
        this.gitlabPass = gitlabPass;
        this.gitlabGroup = gitlabGroup;
        this.gitLabProject = gitLabProject;
        this.idMinValue = idMinValue;
        this.idMaxValue = idMaxValue;

        init();
    }

    private void init() {
        try {
            localBaseDir = Files.createTempDirectory(gitlabGroup);
            localRepoDir = Files.createDirectory(Paths.get(localBaseDir.toString(), gitLabProject));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        gitlabProperties = new GitlabProperties();
        gitlabProperties.setGroup(gitlabGroup);
        gitlabProperties.setHost(gitlabHost);
        gitlabProperties.setIdMinValue(idMinValue);
        gitlabProperties.setIdMaxValue(idMinValue);
        gitlabProperties.setUser(gitlabUser);
        gitlabProperties.setPassword(gitlabUser);
        gitlabProperties.setLocalBaseDir(localBaseDir.toString());
    }

    // ------------------------------------------------------------------------

    /**
     * Deletes the temp directory and all its contents.
     */
    public void cleanup() {
        deleteDirectory(localBaseDir);
    }

    public void deleteDirectory(Path directoryToDelete) {
        if (Files.exists(directoryToDelete) && Files.isDirectory(directoryToDelete)) {
            log.info("deleting {}", directoryToDelete.toString());
            try {
                Files.walk(directoryToDelete, FileVisitOption.FOLLOW_LINKS)
                    .sorted(Comparator.reverseOrder())
                    .map(Path::toFile)
                    .peek(System.out::println)
                    .forEach(File::delete);
            } catch (Exception e) {
                throw new RuntimeException("Error trying to delete a directory", e);
            }
        }
    }
}
