/*
 *  Copyright 2017 Regents of the University of California.
 *
 *  Licensed under the Educational Community License, Version 2.0 (the "license");
 *  you may not use this file except in compliance with the License. You may
 *  obtain a copy of the license at
 *
 *  https://opensource.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

package org.opentestsystem.ap.ims.service;

import org.opentestsystem.ap.common.model.Attachment;
import org.opentestsystem.ap.common.util.ValidationException;
import org.opentestsystem.ap.ims.model.BrailleFile;
import org.springframework.stereotype.Component;

import static org.apache.commons.lang3.StringUtils.equalsIgnoreCase;
import static org.apache.commons.lang3.StringUtils.split;

@Component
public class FileUploadServiceMapper {

    private static final String BRAILLE_TYPE_BRF = "BRF";

    private static final String BRAILLE_TYPE_PRN = "PRN";

    /**
     * Creates an {@link Attachment} instance from a {@link BrailleFile}.  It is mapping an IMS model to the common
     * model.
     *
     * @param brailleFile The file details being uploaded.
     * @return An {@link Attachment} instance.
     */
    public Attachment newAttachment(final BrailleFile brailleFile) {
        final Attachment attachment = new Attachment();
        attachment.setFileName(brailleFile.getFileName());
        attachment.setType(brailleFile.getType());
        attachment.setSubtype(brailleFile.getSubtype());
        attachment.setLanguage(brailleFile.getLanguage());
        return attachment;
    }

    /**
     * Using the file name an instance of {@link BrailleFile} is created.  A file name is expected in a specific format.
     * It is assumed the file name format has been validated prior to calling this method.
     * <p>
     * <p>
     * "stim_8393_enu_contracted_transcript.brf" and "stim_8393_enu_contracted.brf" are examples of valid braille file
     * names.  The file name contains the different parts making up a {@link BrailleFile}
     *
     * @param fileName The file name to parse for the braille file data.
     * @return A {@link BrailleFile} instance.
     */
    public BrailleFile newBrailleFile(final String fileName) {
        if (fileName == null) {
            throw new ValidationException("File name cannot be null");
        }

        // first split on the extension
        final String[] splitOnExtension = split(fileName, ".");

        final String brailleType = equalsIgnoreCase(splitOnExtension[1], BRAILLE_TYPE_BRF.toLowerCase()) ?
            BRAILLE_TYPE_BRF : BRAILLE_TYPE_PRN;

        final String[] splitOnName = split(splitOnExtension[0], "_");

        final BrailleFile brailleFile = new BrailleFile();
        brailleFile.setFileName(fileName);
        brailleFile.setType(brailleType);
        brailleFile.setItemId(splitOnName[1]);
        brailleFile.setItemType(splitOnName[0]);
        brailleFile.setLanguage(splitOnName[2]);

        if (splitOnName.length == 5) {
            brailleFile.setSubtype(splitOnName[3] + "_" + splitOnName[4]);
        } else {
            brailleFile.setSubtype(splitOnName[3]);
        }

        return brailleFile;
    }

}
